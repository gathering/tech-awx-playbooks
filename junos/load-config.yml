---
- name: Push config
  hosts: auto-provision
  gather_facts: no
  connection: local
  collections:
     - juniper.device

  tasks:
  - name: Push Config - Block
    block:
      - name: Load conf. Confirm within 5 min. Wait 3 secs between chk and commit
        config:
          host: "{{ mgmt_v4_addr }}"
          user: "{{ lookup('env','ANSIBLE_NET_USERNAME') }}"
          passwd: "{{ lookup('env','ANSIBLE_NET_PASSWORD') }}"
          load: 'override'
          format: 'text'
          url: "{{ gondul_url }}/api/templates/magic.conf?switch={{sysname}}"
          timeout: 240
          confirm: 4
          check_commit_wait: 6
        register: response

      - name: Print the complete response
        debug:
          var: response.diff_lines

      - name: Confirm the previous commit with a commit check (but no commit)
        config:
          host: "{{ mgmt_v4_addr }}"
          user: "{{ lookup('env','ANSIBLE_NET_USERNAME') }}"
          passwd: "{{ lookup('env','ANSIBLE_NET_PASSWORD') }}"
          check: true
          diff: false
          commit: false
          timeout: 90
        register: response

      - name: Print the complete response
        debug:
          var: response.diff_lines

      - name: Print play hosts that FAP'd
        debug:
          msg: "{{ansible_play_batch |join(',')}}"
        run_once: true

      - name: Print play hosts that failed
        debug:
          msg: "The hosts that failed are {{ ansible_play_hosts_all| difference(ansible_play_batch) |join(',') }}"
        run_once: true

    always:
      - name: Post to Gondul - Successfull
        vars:
          hosts: "{{ansible_play_batch |join(',')}}"
        ansible.builtin.uri:
          url: "{{ gondul_url }}/api/write/oplog"
          user: tech
          password: Sb6CEsyK
          method: POST
          body:
            user: AWX
            systems: "{{hosts}}"
            log: "Successfull reFAP job - ID:{{tower_job_id}}"
          force_basic_auth: true
          body_format: json
        run_once: true
        when: hosts | length > 0

      - name: Post to Gondul - Failed
        vars:
          hosts: "{{ ansible_play_hosts_all| difference(ansible_play_batch) |join(',') }}"
        ansible.builtin.uri:
          url: "{{ gondul_url }}/api/write/oplog"
          user: tech
          password: Sb6CEsyK
          method: POST
          body:
            user: AWX
            systems: "{{ hosts }}"
            log: "Failed reFAP job - ID:{{tower_job_id}}"
          force_basic_auth: true
          body_format: json
        run_once: true
        when: hosts | length > 0

    rescue:
      - name: Post to Gondul - Failed totally
        ansible.builtin.uri:
          url: "{{ gondul_url }}/api/write/oplog"
          user: tech
          password: Sb6CEsyK
          method: POST
          body:
            user: AWX
            systems: ""
            log: "reFAP job failed horribly- ID:{{tower_job_id}}"
          force_basic_auth: true
          body_format: json
        run_once: true
